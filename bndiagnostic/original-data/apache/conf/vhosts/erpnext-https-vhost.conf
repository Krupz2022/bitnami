<VirtualHost 127.0.0.1:443 _default_:443>
  ServerName www.example.com
  ServerAlias *
  SSLEngine on
  SSLCertificateFile "/opt/bitnami/apache/conf/bitnami/certs/server.crt"
  SSLCertificateKeyFile "/opt/bitnami/apache/conf/bitnami/certs/server.key"
  DocumentRoot /opt/bitnami/erpnext/frappe-bench/sites
  <Directory "/opt/bitnami/erpnext/frappe-bench/sites">
    Options -Indexes +FollowSymLinks -MultiViews
    AllowOverride All
    Require all granted
  </Directory>
  # BEGIN: Virtualenv configuration
  <IfDefine !IS_ERPNEXT_LOADED>
    Define IS_ERPNEXT_LOADED
    WSGIDaemonProcess erpnext user=daemon group=daemon processes=2 threads=15 display-name=%{GROUP} python-home=/opt/bitnami/erpnext/frappe-bench/env home=/opt/bitnami/erpnext/frappe-bench/sites
  </IfDefine>
  WSGIProcessGroup erpnext
  WSGIApplicationGroup %{GLOBAL}
  # Avoid '504 Gateway Timeout' errors while executing the application's setup wizard
  TimeOut 120
  # END: Virtualenv configuration
  # BEGIN: ERPNext configuration
  # Based on the 'nginx.conf' template with modifications for WSGI support
  # https://github.com/frappe/bench/blob/develop/bench/config/templates/nginx.conf
  # A final version of the 'nginx.conf' can be generated by executing 'bench setup nginx' and checking 'config/nginx.conf' afterwards
  # Block: 'location /assets'
  Alias /assets /opt/bitnami/erpnext/frappe-bench/sites/assets
  <Directory /opt/bitnami/erpnext/frappe-bench/sites/assets>
    Require all granted
  </Directory>
  # Block: 'location ~ ^/protected/(.*)'
  Alias /protected /opt/bitnami/erpnext/frappe-bench/sites/erpnext/
  <Directory /protected>
    Require local
  </Directory>
  # Block: 'location /socket.io'
  <Location /socket.io/>
    RewriteEngine On
    RewriteCond %{REQUEST_URI}  ^/socket.io/           [NC]
    RewriteCond %{QUERY_STRING} transport=websocket    [NC]
    RewriteRule /(.*)           ws://localhost:3000/$1 [P,L]
    ProxyPass         http://localhost:3000/socket.io/
    ProxyPassReverse  http://localhost:3000/socket.io/
  </Location>
  # Block: 'location /'
  RewriteEngine on
  RewriteRule ^(.+)/$ $1 [R=permanent,L]
  RewriteRule ^(.+)/index\.html$ $1 [R=permanent,L]
  RewriteRule ^(.+)\.html$ $1 [R=permanent,L]
  # -> Sub-block: 'location ~ ^/files/.*.(htm|html|svg|xml)'
  Alias /files /opt/bitnami/erpnext/frappe-bench/sites/erpnext/public/files
  <Location ~ ^/files/.*.(htm|html|svg|xml)>
    Header set Content-Disposition attachment
  </Location>
  <Directory /opt/bitnami/erpnext/frappe-bench/sites/erpnext/public/files>
    Require all granted
  </Directory>
  # -> Sub-block: 'try_files /erpnext/public/$uri'
  WSGIScriptAlias / /opt/bitnami/erpnext/frappe-bench/apps/frappe/frappe/app.py
  <Directory /opt/bitnami/erpnext/frappe-bench/apps/frappe/frappe>
    Options +MultiViews
    Require all granted
  </Directory>
  # Block: 'location @webserver'
  <Location />
    RequestHeader set X-Frappe-Site-Name erpnext
  </Location>
  # Block: error pages
  ErrorDocument 502 /502.html
  Alias /502.html /opt/bitnami/erpnext/bench/bench/config/templates/502.html
  <Directory /opt/bitnami/erpnext/bench/bench/config/templates>
    Require all granted
  </Directory>
  # END: ERPNext configuration
</VirtualHost>
